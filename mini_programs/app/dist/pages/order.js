"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var o=0;o<t.length;o++){var a=t[o];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,o,a){return o&&e(t.prototype,o),a&&e(t,a),t}}(),_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var o=arguments[t];for(var a in o)Object.prototype.hasOwnProperty.call(o,a)&&(e[a]=o[a])}return e},_dec,_class,_wepy=require("./../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),_wepyRedux=require("./../npm/wepy-redux/lib/index.js"),_actions=require("./../store/actions/index.js"),_config=require("./../const/config.js"),_loadmore=require("./../components/loadmore.js"),_loadmore2=_interopRequireDefault(_loadmore),STATUS_VALUE={0:"发起",1:"已支付",2:"已完成",3:"取消中",4:"已取消"},Order=(_dec=(0,_wepyRedux.connect)({userId:function(e){return e.user.id},userCheck:function(e){return e.user.check},orders:function(e){return e.order.orders.map(function(e){return _extends({},e,{details:JSON.parse(e.details),businessName:e.receiver_info.nickname,avatar:e.receiver_info.avatar?_config.BASE_API+e.receiver_info.avatar:"/assets/imgs/avatar.png",statusValue:STATUS_VALUE[""+e.status]})})},ordersLength:function(e){return e.order.orders.length}},{}))(_class=function(e){function t(){var e,o,a,n;_classCallCheck(this,t);for(var r=arguments.length,s=Array(r),i=0;i<r;i++)s[i]=arguments[i];return o=a=_possibleConstructorReturn(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(s))),a.config={navigationBarTitleText:"我的订单",enablePullDownRefresh:!0},a.$repeat={},a.$props={LoadMore:{"xmlns:v-bind":"","v-bind:loadingMore.sync":"loadingMore","v-bind:hasMore.sync":"hasMore"}},a.$events={},a.components={LoadMore:_loadmore2.default},a.mixins=[],a.data={loginImg:"/assets/imgs/login.png",toolbars:[{label:"进行中",checked:!0,value:[0,1,3]},{label:"已完成",checked:!1,value:[2]},{label:"已取消",checked:!1,value:[4]}],pageSize:5,pageNo:1,status:[0,1,3],loadingMore:!1,hasMore:!0},a.computed={},a.methods={handleToLogin:function(){_wepy2.default.navigateTo({url:"/pages/login"})},handleToolbarChange:function(e){this.toolbars.forEach(function(t){t.label===e.label?t.checked=!0:t.checked=!1}),this.status=e.value,this.pageNo=1,this.loadOrders()},handleLoadMore:function(){var e=this;e.hasMore&&!e.loadingMore&&(e.pageNo++,e.loadingMore=!0,(0,_wepyRedux.getStore)().dispatch((0,_actions.asyncGetMoreOrders)({token:_wepy2.default.getStorageSync("token"),status:e.status,pageSize:e.pageSize,pageNo:e.pageNo})).then(function(t){if(_wepy2.default.stopPullDownRefresh(),e.loadingMore=!1,e.$apply(),t.error)return void _wepy2.default.showToast({title:t.payload.message,icon:"none"});(t.payload.data||[]).length<e.pageSize?e.hasMore=!1:e.hasMore=!0,e.$apply()}))},handlePayOrder:function(e){var t=this;_wepy2.default.showModal({title:"提示",content:"是否确认支付该订单?",success:function(o){o.confirm&&(_wepy2.default.showLoading({title:"支付中"}),(0,_wepyRedux.getStore)().dispatch((0,_actions.asyncPayOrder)({token:_wepy2.default.getStorageSync("token"),id:e.id})).then(function(e){if(_wepy2.default.hideLoading(),e.error)return void _wepy2.default.showModal({title:"支付失败",content:e.payload.message,showCancel:!1});t.pageNo=1,t.$apply(),t.loadOrders()}))}})},handleCancelOrder:function(e){var t=this;_wepy2.default.showModal({title:"提示",content:"是否确认取消该订单?",success:function(o){o.confirm&&(_wepy2.default.showLoading({title:"取消中"}),(0,_wepyRedux.getStore)().dispatch((0,_actions.asyncCancelOrder)({token:_wepy2.default.getStorageSync("token"),id:e.id})).then(function(e){if(_wepy2.default.hideLoading(),e.error)return void _wepy2.default.showModal({title:"取消失败",content:e.payload.message,showCancel:!1});t.pageNo=1,t.$apply(),t.loadOrders()}))}})},handleFinishOrder:function(e){var t=this;_wepy2.default.showModal({title:"提示",content:"是否确认该订单已完成?",success:function(o){o.confirm&&(_wepy2.default.showLoading({title:"提交中"}),(0,_wepyRedux.getStore)().dispatch((0,_actions.asyncFinishOrder)({token:_wepy2.default.getStorageSync("token"),id:e.id})).then(function(e){if(_wepy2.default.hideLoading(),e.error)return void _wepy2.default.showModal({title:"提交失败",content:e.payload.message,showCancel:!1});t.pageNo=1,t.$apply(),t.loadOrders()}))}})},handleToBI:function(e){(0,_wepyRedux.getStore)().dispatch((0,_actions.asyncSearchBusiness)(e.receiver_id)).then(function(e){e.error?_wepy2.default.showModal({title:"提示",showCancel:!1,content:e.payload.message}):_wepy2.default.navigateTo({url:"/pages/business_info"})})}},a.events={},n=o,_possibleConstructorReturn(a,n)}return _inherits(t,e),_createClass(t,[{key:"onPullDownRefresh",value:function(){var e=this;e.pageNo=1,e.$apply(),e.loadOrders()}},{key:"loadOrders",value:function(e){var t=this;_wepy2.default.showLoading({title:"加载中"}),(0,_wepyRedux.getStore)().dispatch((0,_actions.asyncGetOrders)({token:_wepy2.default.getStorageSync("token"),status:t.status,pageSize:t.pageSize,pageNo:t.pageNo})).then(function(e){if(_wepy2.default.hideLoading(),_wepy2.default.stopPullDownRefresh(),e.error)return void _wepy2.default.showToast({title:e.payload.message,icon:"none"});(e.payload.data||[]).length<t.pageSize?t.hasMore=!1:t.hasMore=!0,t.loadingMore=!1,t.$apply()})}},{key:"onShow",value:function(){this.userCheck&&this.loadOrders()}}]),t}(_wepy2.default.page))||_class;Page(require("./../npm/wepy/lib/wepy.js").default.$createPage(Order,"pages/order"));